{% extends "base.html" %}

{% block content %}
  <link rel="stylesheet" href="{{ url_for('games_assets_bp.static', filename='css/style.css') }}">
  <style>
    /* Sum4 specific overrides that don't conflict with common CSS */
    .sum4-wrapper {
      max-width: var(--max-w);
      margin: 0 auto;
      padding: 20px;
    }
    
    #solutionPanel.sum4-solution {
      max-width: 500px;
      margin: 16px auto;
    }
  </style>

  <!-- Confirmation Modals (matching Game24) -->
  <div id="restartModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Restart Game?</h3>
        <button class="close" id="restartClose">✕</button>
      </div>
      <p>Are you sure you want to restart? This will reset all game statistics.</p>
      <div class="modal-buttons">
        <button id="restartCancel" class="secondary-btn">Cancel</button>
        <button id="restartConfirm" class="danger-btn">Restart</button>
      </div>
    </div>
  </div>

  <div id="exitModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-head">
        <h3>Exit Game?</h3>
        <button class="close" id="exitClose">✕</button>
      </div>
      <p>Are you sure you want to exit? You'll see your session statistics.</p>
      <div class="modal-buttons">
        <button id="exitCancel" class="secondary-btn">Cancel</button>
        <button id="exitConfirm" class="primary-btn">Exit</button>
      </div>
    </div>
  </div>

  <!-- Summary Modal (matching Game24) -->
  <div class="modal-backdrop" id="summaryBackdrop" role="dialog" aria-modal="true" style="display:none;">
    <div class="modal">
      <div class="modal-head">
        <h3>Session Summary</h3>
        <button class="close" id="summaryClose" style="cursor:pointer">✕</button>
      </div>
      <div id="summary-report" style="max-height:50vh; overflow:auto;"></div>
      <div class="actions" style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <a id="summaryCsv" class="primary-btn" href="#" target="_blank" rel="noopener" style="display:none">Download CSV</a>
        <button id="summaryExit" class="danger-btn">Exit Game</button>
        <button id="summaryResume" class="secondary-btn">Resume</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header class="game-header">
      <h1 class="game-title">Sum 4 Cards</h1>
      <p class="game-subtitle">Add the revealed cards step-by-step (or all at once)</p>
    </header>

    <div class="panel">
      <!-- TOPLINE - EXACTLY LIKE GAME24 -->
      <div class="topline">
        <span id="question">Ready — press Deal</span>
        <span id="timer">00:00.0</span>

        <div class="right-tools">
          <details class="settings">
            <summary>Settings</summary>

            <div class="settings-row">
              <label>
                Reveal Mode
                <select id="revealMode">
                  <option value="step">Step by step</option>
                  <option value="all">All at once</option>
                </select>
              </label>

              <label>
                Difficulty
                <select id="difficulty">
                  <option value="">Auto</option>
                  <option value="easy">Easy</option>
                  <option value="medium">Medium</option>
                  <option value="hard">Hard</option>
                </select>
              </label>

              <label>
                <input type="checkbox" id="autoDeal">
                Auto-Deal
              </label>
            </div>

            <!-- Pool Section (like Game24) -->
            <div class="settings-row">
              <label>Jump to Case ID:
                <input type="number" id="caseIdInput" placeholder="e.g., 125"
                       min="1" max="1820"
                       title="Enter a number between 1 and 1820"
                       style="width: 80px;">
              </label>
              <button id="loadCaseBtn" class="info-btn">Go</button>
            </div>

            <!-- Custom/Competition pool -->
            <div class="settings-row" id="casePoolRow" style="display:none;">
              <label for="casePoolInput" style="display:block;">Case Pool (IDs)</label>

              <div class="row-inline" style="display:grid; grid-template-columns:minmax(260px,1fr) auto auto; gap:8px; align-items:center;">
                <input id="casePoolInput" type="text" placeholder="e.g., 18, 28, 95, 108" />
                <label for="compDurationInput" class="inline-label" style="white-space:nowrap;">
                  Duration (min)
                  <input id="compDurationInput" type="number" min="1" max="60" step="1" value="5" style="width:72px; margin-left:6px;">
                </label>
                <button id="saveCasePool" class="info-btn" title="Use these IDs for Custom/Competition" style="justify-self:end;">Save Pool</button>
              </div>

              <small class="muted block">Up to 25 IDs (1–1820). Any separators: space, comma, or "|".</small>
              <small class="muted block">Custom: help enabled. Competition: help disabled, timed play.</small>
            </div>

            <!-- Pool mode selector -->
            <div class="settings-row">
              <label>Pool Mode
                <select id="poolState">
                  <option value="single">Single Case (Normal)</option>
                  <option value="custom">Custom Pool (Practice)</option>
                  <option value="competition">Competition (Timed)</option>
                </select>
              </label>
            </div>
          </details>

          <span class="link" id="howtoLink" title="How to play">?</span>
        </div>
      </div>

      <div class="board">
        <!-- Cards - Using common CSS classes -->
        <div id="cards" class="cards sum4-cards-container"
             data-game-key="{{ game_key }}"
             data-back="{{ url_for('games_assets_bp.static', filename='cards/back.png') }}"
             data-void="{{ url_for('games_assets_bp.static', filename='cards/void.png') }}"
             data-init='{{ initial_cfg | tojson }}'>
          <img class="card" id="card-0" alt="back">
          <img class="card" id="card-1" alt="back">
          <img class="card" id="card-2" alt="back">
          <img class="card" id="card-3" alt="back">
        </div>

        <!-- Message - Using common CSS class -->
        <div id="msg" class="status"></div>

        <!-- Answer box - Using common CSS classes -->
        <div class="answer-container">
          <input id="answer" class="answer-box" type="number" inputmode="numeric" 
                 placeholder="Enter running sum…" autocomplete="off" />
          <div id="answerFeedback" class="answer-feedback"></div>
        </div>

        <!-- Numeric keypad (replaces operators) -->
        <div class="num-panel">
          <div class="num-wrap" id="numPad">
            <button data-num="7">7</button>
            <button data-num="8">8</button>
            <button data-num="9">9</button>
            <button data-num="4">4</button>
            <button data-num="5">5</button>
            <button data-num="6">6</button>
            <button data-num="1">1</button>
            <button data-num="2">2</button>
            <button data-num="3">3</button>
            <button data-num="0">0</button>
          </div>
        </div>

        <!-- Main actions - EXACTLY LIKE GAME24 BUTTON ROWS -->
        <div class="button-row">
          <button id="backspace" class="danger-btn">⌫ Back</button>
          <button id="clear" class="clear-btn">Clear</button>
          <button id="check" class="success-btn">Check (Enter)</button>
          <button id="deal" class="primary-btn">Deal (D)</button>
        </div>

        <!-- Secondary actions - EXACTLY LIKE GAME24 -->
        <div class="button-row">
          <button id="help" class="info-btn">Help (H)</button>
          <button id="skip" class="danger-btn">Skip (N)</button>
          <button id="restart" class="danger-btn">Restart (R)</button>
          <button id="exit" class="secondary-btn">Exit (X)</button>
        </div>

        <!-- Solutions - Using common CSS classes -->
        <div id="solutionPanel" class="solution-panel-hidden sum4-solution">
          <div id="solutionMsg"></div>
        </div>

        <!-- Stats - Using common CSS class -->
        <div class="stats">
          <span id="played">Played: 0</span>
          <span id="solved">Solved: 0</span>
          <span id="helps">Helps: 0</span>
          <span id="incorrect">Incorrect: 0</span>
          <span id="skipped">Skipped: 0</span>
          <span id="totalTime">Time: 00:00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- How-to Modal (matching Game24 structure) -->
  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" style="display:none;">
    <div class="modal">
      <div class="modal-head">
        <h3>How it works</h3>
        <button class="close" id="modalClose" style="cursor:pointer">✕</button>
      </div>

      <div class="tabs">
        <button class="tab-link active" data-tab="basic">Basics</button>
        <button class="tab-link" data-tab="strategies">Strategies</button>
        <button class="tab-link" data-tab="teacher">Teacher Mode</button>
      </div>

      <div id="basic" class="tab-content" style="display:block;">
        <ul>
          <li>Reveal style decides how many cards you see first.</li>
          <li>Type the running sum of the visible cards and press <b>Check</b>.</li>
          <li>If correct, the next card(s) reveal. Finish all steps to complete the hand.</li>
          <li><b>Difficulty</b> filters which cases are dealt (easy / medium / hard / auto).</li>
          <li><b>Pool</b> lets you practice specific cases or run a timed competition.</li>
          <li>Shortcuts: <b>Enter</b>=Check, <b>D</b>=Deal, <b>N</b>=Skip,
              <b>H</b>/<b>Shift+H</b>=Help, <b>R</b>=Restart, <b>X</b>=Exit</li>
        </ul>
      </div>

      <div id="strategies" class="tab-content">
        <h4>Strategies</h4>
        <ol>
          <li><strong>Step-by-step mode:</strong> Add cards sequentially as they reveal</li>
          <li><strong>All-at-once mode:</strong> Calculate the total sum of all 4 cards</li>
          <li><strong>Practice mode:</strong> Use custom pools to focus on specific cases</li>
          <li><strong>Competition mode:</strong> Timed practice with help disabled</li>
        </ol>
      </div>

      <div id="teacher" class="tab-content">
        <h4>Teacher Mode</h4>
        <p><strong>Custom Pool</strong>: Enter up to 25 case IDs for focused practice. Help allowed.</p>
        <p><strong>Competition Pool</strong>: Same pool with timer. Help disabled for assessment.</p>
        <p><strong>Single Case</strong>: Normal play with random case selection.</p>
      </div>
    </div>
  </div>

  <!-- Generic Confirm Modal (matching Game24) -->
  <div id="confirmBackdrop" class="confirm-backdrop" style="display:none;">
    <div>
      <div class="modal-head">
        <h3 id="confirmTitle">Are you sure?</h3>
      </div>
      <p id="confirmMsg">This will restart your session.</p>
      <div class="actions">
        <button id="confirmCancel" type="button" class="secondary-btn">Cancel</button>
        <button id="confirmOK" type="button" class="danger-btn">Yes</button>
      </div>
    </div>
  </div>

  <script src="{{ url_for('sum4.static', filename='js/sum4.js') }}"></script>
{% endblock %}
